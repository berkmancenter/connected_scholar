<% content_for :head do %>
  <!-- stylesheets -->
  <link href="/static/css/pad.css" rel="stylesheet" />
  <%= render :partial => 'pad_js'%>
  <style type="text/css" title="dynamicsyntax"></style>

  <script type="text/javascript">

    $(function(){
	  setupDraggables();
    });

	function setupDraggables(){
		$(".draggable").draggable({zIndex: 100, helper: 'clone', handle: "p", appendTo: 'body', iframeFix: true, start: startDrag });
	}
	function startDrag(event,ui){
      $(ui.helper).prepend('<div class="preDrag"></div>');
      $(this).data('draggable').offset.click.top += 36;
      setupDropzone();
    }

    function setupDropzone(){
	  var win = window.parent.frames[1].frames[0].window;
      var doc = window.parent.frames[1].frames[0].document;
      var innerdocbody = $(doc).find("#innerdocbody");
      var allmagic = innerdocbody.find('div[id^="magicdomid"]');
      allmagic.droppable({
	    hoverClass: 'custom-hover',
        drop: function(event, ui){
          var target = $(event.target).prev();
          var node = doc.getElementById(target.attr("id"));
          target.focus(function() {
            window.setTimeout(function() {
              setCursorPosition(0, node, doc, win);
            }, 0);
          });
          //create the new line after drop target
		  resource_id = ui.draggable.attr("id").replace("drag_resource_", "");
		  document_id = "<%= @document.id %>";
		  citation_div = '<div id="' + document_id + '_' + resource_id + '"></div>';
          target.after(citation_div);
          setCitation(document_id, resource_id);
          target.attr('tabindex', -1).focus();
		  target.removeAttr('tabindex');
          return true;
        }
      });
    }

    function setCursorPosition(pos, node, doc, win){
        var sel, range;
        if (win.getSelection && doc.createRange) {
          range = doc.createRange();
          range.selectNode(node);
          range.setStart(node, pos);
          range.setEnd(node, pos);
          range.collapse(true);
          sel = win.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        } else if (node.createTextRange) {
          range = node.createTextRange();
          range.collapse(true);
          range.select();
        }
    }
	
	function setCitation(document_id, resource_id){
		$.get("/documents/" + document_id + "/resources/" + resource_id + "/citation", function(data){
			var citation = data["citation"];
	      	var doc = window.parent.frames[1].frames[0].document;
	      	var citationDiv = $(doc).find("#"+document_id+"_"+resource_id);
			citationDiv.html(citation);	
			var innerdocbody = $(doc).find("#innerdocbody");
			var span = $('span:contains("'+citation+'")', innerdocbody);
			span.die('contextmenu');
			span.live('contextmenu', {citation: citation, resource_id: resource_id, document_id: document_id}, 
			  function(event){
				event.preventDefault();
				citation = event.data.citation;
				resource_id = event.data.resource_id;
				document_id = event.data.document_id;
				alert("Citation: "+citation+"\nDocument: "+document_id+" \nResource: "+resource_id+" \nClicked!");
			  })
		}, 'json');
		$.post("/documents/"+document_id+"/resources/"+resource_id+"/activate", function(data){
			if(data.length > 0){
				$("#resource_"+resource_id).remove();
				$("#active_sources").append(data);
			}
			setupDraggables();
		})
	}
  </script>

<% end %>

  <%= render :partial => 'pad_left'%>
  <%= render :partial => 'pad_middle'%>
  <%= render :partial => 'pad_right'%>
